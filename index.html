<!DOCTYPE html>
<html>
<head>
<title>DougPost</title>
<meta charset="UTF-8">
<script
  src="https://code.jquery.com/jquery-3.1.1.min.js"
  integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
  crossorigin="anonymous">
</script>


<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.2/jsgrid.min.css" />
<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.2/jsgrid-theme.min.css" />
 
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.2/jsgrid.min.js"></script>
<style>
      body {font-family: Arial, Helvetica, sans-serif}
      #topdiv {margin: 0 auto; width: 90%;}
      .perm { font-size: small; border: thin solid blue; background-color:lightBlue;border-radius: 1em;padding:.2em;white-space:nowrap}
      .permlist { }
</style>
<script>

  var selectedPage;
  var permEasyNames = { ADMINISTER: 'Admin', EDIT_PROFILE: 'Edit', CREATE_CONTENT: 'Create Content', MODERATE_CONTENT: 'Moderate', CREATE_ADS: 'Ads', BASIC_ADMIN: 'Basic' };

  window.fbAsyncInit = function() {
    FB.init({
      appId      : '536759713186208',
      xfbml      : false,  // if true will parse page looking for other xbfml plugins
      version    : 'v2.8',
      status     : true,
      cookie     : true
    });
    FB.Event.subscribe('auth.authResponseChange', initDougPost);
    console.log('FInishing fbAsyncInit.');
    
    FB.getLoginStatus(initDougPost);  // this isn't being called by the authResponseChange event initially... (?)
  };


  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));

function initDougPost(r) {
  console.log('r.status is '+r.status);
  if (r.status === 'connected') {
    if (selectedPage) { listPosts(); }
    else { listPages(); }
    }
  else if (r.status === 'not_authorized') {
    $('#x').html("<button onclick='FB.login(initDougPost, {scope:&quot;pages_show_list&quot;})'>The app needs your permission to list your pages</button>");

    }
  else {
    $('#x').html("<button onclick='FB.login(initDougPost, {scope:&quot;pages_show_list&quot;})'>Log in to Facebook to enable the app</button>");
    }


  console.log('In initDougPost with '+JSON.stringify(r));
  $('#dpstatus').html(JSON.stringify(r));
  }
function listPages() {
  console.log('listing pages');
  var pages = [];
  FB.api('/me/accounts', function(response) {
    var pages = response['data'].map( function (x) {
      return {   id: x['id'],
               name: x['name'],
           category: x['category'],
              views: "<span id='page_"+x['id']+"views'></span>",  // placehoder for viewcount, to be added later by api callbacks
             access: "<div class='permlist'>"+x['perms'].map( function (x) { return "<span class='perm'>"+permEasyNames[x]+'</span>'; } ).join(' ')+'</div>'
        };}
      );

    $('#x').html("<div id='jsGrid'></div><a href=''>Previous</a>");

    $("#jsGrid").jsGrid({
        width: "100%",
        height: "400px",
 
        inserting: false,
        editing: true,
        sorting: true,
        paging: true,
 
        onInit: function () {
                  response['data'].forEach( function (p) { FB.api( '/' + p.id +'/insights/page_views_total',
                  function (r) { if (r && !r.error) { console.log('views for '+x['id']);$("#page_"+x['id']+"views").html( 'views: ' + r.data.views.value) } }); } 
                                                        ) },
         // TODO (line above) is r.data.views.values the right element?  My pages don't have enough viewcounts to test :(

        data: pages,
        rowClick: function (a) { selectedPage=a.item; FB.getLoginStatus(initDougPost);},
 
        fields: [
            { name: "name", title: "Name", type: "text", width: "30%" },
            { name: "category", title: "Category", type: "text", width: "40%" },
            { name: "views", title: "Views", type: "number", width: "10%"},
            { name: "access", title: "Access", type: "text", width: "20%" }
        ]
      });

     console.log('the response is '+JSON.stringify(response));
     });
  }

function listPosts() {

  FB.api('/'+selectedPage['id']+'/posts', function(response) {
    var posts = response['data'].map( function (x) {
      return {   type: x['message'] ? 'Message' : 'Story',
              message: x['message'] || x['story'],
         created_time: x['created_time']
             };
     } );
    

    console.log(JSON.stringify(response));
    $('#x').html("<a href='javascript:selectedPage=null;FB.getLoginStatus(initDougPost);'>Back to list of pages</a><p><div id='jsGrid'></div>");
    $("#jsGrid").jsGrid({
        width: "100%",
        height: "400px",
 
        inserting: false,
        editing: true,
        sorting: true,
        paging: true,
 
        data: posts, 
        rowClick: function (a) { selectedPage=a.item; FB.getLoginStatus(initDougPost);},
 
        fields: [
            { name: 'type', title: 'Type of Post', type: 'text', width: '10%' },
            { name: "created_time", title: 'When Created', type: "text", width: "40%" },
            { name: 'message', title: 'Text Content of Post', type: 'text', width: '20%' },
        ]
      });
    });
  
  }

</script>


</head>

<body>
<div id=topdiv>
<h2>DougPost</h2>
<div id=x></div>

</div>

</body>

</html>
